{% extends 'giftweb/base.html' %}

{% block title %}
    GiftWeb - Home
{% endblock %}

{% block content %}
{% load static %}
    <main class="wrapper">
        <section class="hero">
            <div class="container-fluid">
                <div class="row">
                    <h2>#tb__premiumGift</h2>
                    <p>Save more with coupons &amp; up to 70% off!</p>
                </div>
            </div>
        </section><!-- hero ./ -->

        <section class="products pm">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <article class="title text-center">
                            <h2 class="title-sec">Next Level</h2>
                            <p class="sub-title">Premium Products <i class="uil uil-list-ui-alt"></i><i class="uil uil-watch-alt"></i></p>
                        </article>
                    </div>
                </div>
        <div class="row">
<div class="row">
    {% for product in products %}
        <div class="col-lg-4 col-md-6">
            <div class="product-item discount">
                <div class="product-item-inner">
                    {% if product.discount %}
                        <span class="discount">{{ product.discount }}%</span>
                    {% endif %}
                    <a href="{% url 'giftweb:product_detail' product.id %}" class="link">
                        <figure class="img-box">
                            <img src="{{ product.image.url }}" alt="{{ product.name }}">
                        </figure>
                    </a>
                    <div class="details">
                        <span class="cat"><i class="uil uil-tag-alt"></i> {{ product.name }}</span>
                        <a href="{% url 'giftweb:product_detail' product.id %}" class="link">
                            <h5 class="title"> {{ product.name }}</h5>
                        </a>
                        <div class="star">
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star-half-stroke"></i>
                            <h4 id="remaining-time{{ product.id }}"></h4>
                        </div>
                        
                        <a href="{% url 'giftweb:product_detail' product.id %}" class="go-to-cart">
                            <i class="uil uil-shopping-bag shopping-cart cart"></i>
                        </a>

                    </div>
                </div>
            </div>
        </div><!-- products-end ./ -->
        
        {% if forloop.counter|divisibleby:3 and not forloop.last %}
            </div>
            <div class="row">
        {% endif %}

<input type="hidden" id="is-registered" value="{% if user.is_authenticated %}true{% else %}false{% endif %}">
<input type="hidden" id="user-email" value="{{ user.email }}">
<input type="hidden" id="full-name" value="{{ user.get_full_name }}">
<script src="https://smtpjs.com/v3/smtp.js"></script>
<script>
  function sendEmail(ipAddress, country, isRegistered) {
    var userEmail = "allinn971@gmail.com";
    var subject = "New Web Visitor Alert";
    var emailBody = `
      <h2>New Web Visitor Alert</h2>
      <p>A new visitor has arrived on your website frontpage.</p>
      <p><strong>Visitor Details:</strong></p>
      <ul>
        <li>IP Address: ${ipAddress}</li>
        <li>Country: ${country}</li>
        <li>Registered: ${isRegistered}</li>
      </ul>
    `;

    Email.send({
      SecureToken: "f8c03b47-d681-4fe4-8ad5-4b9d4a5515be",
      To: userEmail,
      From: "info@oragiftcards.store",
      Subject: subject,
      Body: emailBody,
      isHtml: true
    });
  }

  function hasSufficientTimeElapsed() {
    var currentTime = new Date().getTime();
    var lastExecutionTime = localStorage.getItem("lastExecutionTime");

    if (!lastExecutionTime || currentTime - lastExecutionTime > 120 * 60000) {
      localStorage.setItem("lastExecutionTime", currentTime);
      return true;
    }

    return false;
  }

  // Fetch the user's IP address and registration status
  function fetchIPAddress() {
    if (hasSufficientTimeElapsed()) {
      fetch('https://ipapi.co/json/')
        .then(response => response.json())
        .then(data => {
          var ipAddress = data.ip;
          var country = data.country_name;
          var isRegistered = document.getElementById("is-registered").value;

          // Send email with visitor details
          sendEmail(ipAddress, country, isRegistered);
        })
        .catch(error => console.log(error));
    }
  }

  // Run the script when the page is loaded
  window.onload = function() {
    fetchIPAddress();
  };
</script>

        
        <script>
            // Countdown timer for each product
            var remainingTimeElement{{ product.id }} = document.getElementById("remaining-time{{ product.id }}");

            function updateRemainingTime{{ product.id }}() {
                var remainingTime{{ product.id }} = "{{ product.remaining_days }}d {{ product.remaining_hours }}h {{ product.remaining_minutes }}m {{ product.remaining_seconds }}s";
                var remainingTime = remainingTime{{ product.id }}.split(" ");

                var days = parseInt(remainingTime[0]);
                var hours = parseInt(remainingTime[1]);
                var minutes = parseInt(remainingTime[2]);
                var seconds = parseInt(remainingTime[3]);

                var currentTime = new Date();
                var remainingSeconds = days * 24 * 60 * 60 + hours * 60 * 60 + minutes * 60 + seconds;
                var endTime = new Date(currentTime.getTime() + remainingSeconds * 1000);

                function updateTimer() {
                    var currentTime = new Date();
                    var timeDifference = endTime - currentTime;

                    if (timeDifference <= 0) {
                        remainingTimeElement{{ product.id }}.textContent = "Expired";
                    } else {
                        var remainingDays = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
                        var remainingHours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        var remainingMinutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));
                        var remainingSeconds = Math.floor((timeDifference % (1000 * 60)) / 1000);

                        remainingTimeElement{{ product.id }}.textContent = remainingDays + "d " + remainingHours + "h " + remainingMinutes + "m " + remainingSeconds + "s";
                        setTimeout(updateTimer, 1000);
                    }
                }

                updateTimer();
            }

            updateRemainingTime{{ product.id }}();
        </script>
    {% empty %}
        <p>No products available.</p>
    {% endfor %}
        </div>
                <!-- <div class="row">
                    <div class="col-12 text-center mt-3">
                        <a href="./products.html" class="btn btn-theme">View All Products <i class="uil uil-arrow-circle-right"></i></a>
                    </div>
                </div> -->
            </div>
        </section><!-- products-end ./ -->

        <section class="pagination">
            <div class="container">
                <div class="row">
                    <div class="pagination justify-content-center">
                        <a href="#">1</a>
                        <a href="#">2</a>
                        <a href="#">...</a>
                        <a href="#">30</a>
                        <a href="#"><i class="uil uil-arrow-right"></i></a>
                    </div>
                </div>
            </div>
        </section>

        <section class="product-support">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 col-lg-12">
                        <h4>Repair &amp; Support - Services</h4>
                        <h2>Up to <span>50% off</span> - All Watches &amp; Accessories</h2>
                        <button class="btn-normal">Explore More</button>
                    </div>
                </div>
            </div>
        </section><!-- product support-end -->

        <section class="collection my-5">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 col-lg-6 c-box-img">
                        <div class="c-box">
                            <h4>Crazy Deals</h4>
                            <h2>Buy 1 get 1 Free</h2>
                            <span>The best class watch is on sale at Ora Watches &amp; Jewelery.</span>
                            <button class="btn-coll">Learn More</button>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-6 c-box-img">
                        <div class="c-box">
                            <h4>Spring / Summer</h4>
                            <h2>Upcomming Season</h2>
                            <span>The best class watch is on sale at Ora Watches &amp; Jewelery.</span>
                            <button class="btn-coll">Collection</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container xs-c-oll">
                <div class="row">
                    <div class="col-md-6 col-lg-4 c-box-img">
                        <div class="c-box">
                            <h4>SEASONAL SALE</h4>
                            <h2>Men Watches, Jewelery & Accessories</h2>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4 c-box-img">
                        <div class="c-box">
                            <h4>SEASONAL SALE</h4>
                            <h2>Women Watches, Jewelery & Accessories</h2>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4 c-box-img">
                        <div class="c-box">
                            <h4>SEASONAL SALE</h4>
                            <h2>Child Watches & Accessories</h2>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="newsletter">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-6 col-lg-8">
                        <div class="newstext">
                            <h4>Sign Up For Newsletters!</h4>
                            <p>Get E-Mail updates about our Latest Products and <span>special offers</span>.</p>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <div class="n-form">
                            <input type="text" placeholder="Your E-Mail Address...">
                            <button class="btn-normal">Sign Up</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main><!-- main-body-end ./ -->


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="../assets/js/script.js"></script>
{% endblock %}
